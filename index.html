<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="RunJOP : RunJOP (Run Just Once Please) is a distributed execution framework to run a command (i.e. a job) only once in a group of servers and can be used together with UNIX/Linux cron to put a crontab schedule in High Availability (HA)." />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>RunJOP</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/danilop/runjop">View on GitHub</a>

          <h1 id="project_title">RunJOP</h1>
          <h2 id="project_tagline">RunJOP (Run Just Once Please) is a distributed execution framework to run a command (i.e. a job) only once in a group of servers and can be used together with UNIX/Linux cron to put a crontab schedule in High Availability (HA).</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/danilop/runjop/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/danilop/runjop/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h3>Run Just Once Please: runjop</h3>

<p>RunJOP (Run Just Once Please) is a distributed execution framework to run a command (i.e. a job) only once in a group of servers.</p>

<p>Some possible use cases are:</p>

<ul>
<li><p>It can be used together with UNIX/Linux <a href="http://en.wikipedia.org/wiki/Cron">cron</a> to put a crontab schedule in High Availability (HA).</p></li>
<li><p>To execute a batch in an <a href="http://aws.amazon.com/autoscaling/">Auto Scaling</a> group by only one of the EC2 instances.</p></li>
<li><p>To execute a command after an SNS notification is received in HA on multiple nodes, using the <code>MessageId</code> as the id of the job to make sure is executed only once.</p></li>
</ul><p>Some features and internals:</p>

<ul>
<li><p>The idea is to use <a href="http://aws.amazon.com/dynamodb/">Amazon DynamoDB</a> to make sure only one server "reserves" the right to execute the command for a certain range of time.</p></li>
<li><p><a href="http://aws.amazon.com/s3/">Amazon S3</a> can optionally be used to consolidate the logs of the jobs in a single repository.</p></li>
<li><p>AWS credentials can be passed using AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY environmental variables.</p></li>
<li><p>In an EC2 instance a IAM role can be used to give access to DynamoDB/S3 resources.</p></li>
</ul><p><strong>This is a personal project. No relation whatsoever exists between this project and my employer.</strong></p>

<h3>License</h3>

<p>Copyright (c) 2013 Danilo Poccia, <code>http://blog.danilopoccia.net</code></p>

<p>This code is licensed under the The MIT License (MIT). Please see the LICENSE file that accompanies this project for the terms of use.</p>

<h3>Introduction</h3>

<p>Running this two commands concurrently on two hosts one of the node will execute the command, the other will not. In this example the command is executed on the "second" node. Debugging info is added to give more information on the execution.</p>

<p>In this example, on the "first" node the "Hello World" command is not executed:</p>

<pre><code>runjop.py --region=eu-west-1 --table myschedule --id my-job --range=10 --node first --s3=s3://BUCKET/mylogs "echo Hello World" --log /tmp/runjop.log -d
DEBUG:runjop:__init__ '{'node': 'first', 's3log': 's3://BUCKET/mylogs', 'region': 'eu-west-1', 'range': '10', 'debug': True, 'table': 'runjop', 'logfile': '/tmp/runjop.log', 'id': 'my-job'}'
INFO:runjop:S3 bucket: 'BUCKET'
INFO:runjop:S3 prefix: 'mylogs/'
DEBUG:runjop:table 'runjop' not found
INFO:runjop:table 'runjop' created
DEBUG:runjop:waiting for table 'runjop' to be active
DEBUG:runjop:table 'runjop' is active
DEBUG:runjop:run '['echo Hello World']'
DEBUG:runjop:now = '2013-02-11 16:03:46'
DEBUG:runjop:last_item = '{u'node': u'second', u'counter': 1, u'job_id': u'my-ls', u'time': u'2013-02-11 16:03:46'}'
DEBUG:runjop:last_time_str = '2013-02-11 16:03:46'
DEBUG:runjop:counter = '1'
DEBUG:runjop:outside of range of 10 seconds: False
INFO:runjop:not outside of range of execution
INFO:runjop:command not executed
</code></pre>

<p>On the "second" node, the "Hello World" command is executed:</p>

<pre><code>runjop.py --region=eu-west-1 --table myschedule --id my-job --range=10 --node second --s3=s3://BUCKET/mylogs "echo Hello World" --log /tmp/runjop.log -d
DEBUG:runjop:__init__ '{'node': 'second', 's3log': 's3://BUCKET/mylogs', 'region': 'eu-west-1', 'range': '10', 'debug': True, 'table': 'runjop', 'logfile': '/tmp/runjop.log', 'id': 'my-job'}'
INFO:runjop:S3 bucket: 'BUCKET'
INFO:runjop:S3 prefix: 'mylogs/'
DEBUG:runjop:table 'runjop' found
DEBUG:runjop:waiting for table 'runjop' to be active
DEBUG:runjop:table 'runjop' is active
DEBUG:runjop:run '['echo Hello World']'
DEBUG:runjop:now = '2013-02-11 16:03:46'
DEBUG:runjop:outside of range of 10 seconds: True
DEBUG:runjop:put result '{u'ConsumedCapacityUnits': 1.0}'
DEBUG:runjop:execute_job 'True'
INFO:runjop:executing command 'echo Hello World'
INFO:runjop:returncode = 0
INFO:runjop:output:
Hello World

INFO:runjop:output written on s3://danilop-fs/logs/runjop-my-ls-20130211-160346-second-0.log
</code></pre>

<p>On DynamoDB the "myschedule" table can be used as an activity log:</p>

<pre><code>job_id    counter  node      time 
"my-job"  1        "second"  "2013-02-11 16:03:46"
"my-job"  2        "first"   "2013-02-11 16:08:52"
</code></pre>

<p>The optional S3 log has the following naming convention:</p>

<pre><code>{table}-{id}-{YYYYMMDD}-{hhmmss}-{node}.log
</code></pre>

<h3>Using with cron</h3>

<p>The previous example can be scheduled using <a href="http://en.wikipedia.org/wiki/Cron">cron</a> on more than one hosts, but only one will actually run it.</p>

<p>In this example two options are removed from the invocation of the tool (compared to the previous one):</p>

<ul>
<li>without the "--node" option the hostname of each node is used</li>
<li>without the "--range" option the default 300 seconds (5 minutes) range is used.</li>
</ul><p>E.g. to execute the job one minute past midnight (00:01) of every day of the month, of every day of the week:</p>

<pre><code>1 0 * * *  /somepath/runjop.py --region=eu-west-1 --table myschedule --id my-job --range=10 --s3=s3://BUCKET/mylogs "echo Hello World" --log /var/log/runjop.log
</code></pre>

<p>E.g. to execute the job to be run every two hours, namely at midnight, 2am, 4am, 6am, 8am, and so on:</p>

<pre><code>0 */2 * * *  /home/username/runjop.py --region=eu-west-1 --table myschedule --id my-job --range=10 --s3=s3://BUCKET/mylogs "echo Hello World" --log /var/log/runjop.log
</code></pre>

<h3>Full Usage</h3>

<pre><code>Usage: runjop.py [options] "&lt;command(s)&gt;"

RunJOP (Run Just Once Please)

A distributed execution framework to run a command (i.e. a job) only once in a group of servers.
This can be used together with UNIX/Linux cron to put a crontab schedule in High Availability (HA).
The idea is to use Amazon DynamoDB to make sure only one server "reserves" the right
to execute the command for a certain range of time.
Amazon S3 can optionally be used to consolidate the logs of the jobs in a single repository.

Options:
  -h, --help       show this help message and exit
  --region=REGION  AWS region to use for DynamoDB (default is us-east-1)
  --table=TABLE    the DynamoDB table use to check concurrency and log job
           executions (a new table is created if not found)
  --id=ID          the unique ID identifying this job across multiple servers
  --node=NODE      an identifier for the node (default on this node is
           current 'hostname')
  --range=S        the range of time (in seconds) in which the execution of
           the job must be unique (default is 300 seconds)
  --s3=URL         the optional S3 path to put the output of the job in
           s3://BUCKET[/PATH] format
  --log=FILE       the local filename to use for logs
  -d, --debug      print debug information
</code></pre>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">RunJOP maintained by <a href="https://github.com/danilop">danilop</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
